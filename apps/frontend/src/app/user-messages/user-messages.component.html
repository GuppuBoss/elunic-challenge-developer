<div class="user-messages-container">
  <p-toast></p-toast>

  <div class="page-header">
    <h1>User Messages</h1>
    <p>View or submit messages from our users</p>
  </div>

  <p-tabView>
    <p-tabPanel header="View Messages">
      <p-card styleClass="message-card">
        <div class="card-header">
          <h2>All Messages</h2>
          <button
            pButton
            icon="pi pi-refresh"
            label="Refresh"
            class="p-button-outlined"
            (click)="refresh()"
          ></button>
        </div>

        <div class="messages-list">
          <p-table
            [value]="messages"
            [rows]="rows"
            [first]="first"
            [paginator]="false"
            [loading]="loading"
            styleClass="p-datatable-sm p-datatable-striped"
            [tableStyle]="{ 'min-width': '50rem' }"
            responsiveLayout="stack"
            breakpoint="960px"
          >
            <ng-template pTemplate="header">
              <tr>
                <th pSortableColumn="username">
                  Username <p-sortIcon field="username"></p-sortIcon>
                </th>
                <th>Message</th>
                <th pSortableColumn="email">
                  Email <p-sortIcon field="email"></p-sortIcon>
                </th>
                <th pSortableColumn="createdAt">
                  Date <p-sortIcon field="createdAt"></p-sortIcon>
                </th>
                <th pSortableColumn="isRead">
                  Status <p-sortIcon field="isRead"></p-sortIcon>
                </th>
                <th>Actions</th>
              </tr>
            </ng-template>
            <ng-template pTemplate="body" let-message>
              <tr [ngClass]="{ 'unread-row': !message.isRead }">
                <td>
                  <div class="field-display">
                    <strong class="field-value">{{ message.username }}</strong>
                  </div>
                </td>
                <td>
                  <div class="field-display">
                    <div class="field-value message-content">
                      {{ message.message }}
                    </div>
                  </div>
                </td>
                <td>
                  <div class="field-display">
                    <span class="field-value">{{
                      message.email || 'N/A'
                    }}</span>
                  </div>
                </td>
                <td>
                  <div class="field-display">
                    <span class="field-value date-cell">{{
                      formatDate(message.createdAt)
                    }}</span>
                  </div>
                </td>
                <td>
                  <div class="field-display">
                    <p-tag
                      class="field-value"
                      [severity]="message.isRead ? 'success' : 'warn'"
                      [value]="message.isRead ? 'Read' : 'Unread'"
                      [rounded]="true"
                    ></p-tag>
                  </div>
                </td>
                <td>
                  <div class="field-display">
                    <div class="field-value">
                      <button
                        pButton
                        icon="pi pi-check"
                        [disabled]="message.isRead"
                        class="p-button-sm p-button-success p-button-rounded"
                        (click)="markAsRead(message)"
                        [attr.aria-label]="'Mark as read'"
                        pTooltip="Mark as read"
                        tooltipPosition="top"
                      ></button>
                    </div>
                  </div>
                </td>
              </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="6">
                  <div *ngIf="!loading" class="empty-message">
                    <i class="pi pi-inbox"></i>
                    <p>No messages found</p>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>

          <div class="paginator-container">
            <p-paginator
              [first]="first"
              [rows]="rows"
              [totalRecords]="totalRecords"
              [rowsPerPageOptions]="[3, 5, 10]"
              (onPageChange)="onPageChange($event)"
            ></p-paginator>
          </div>
        </div>
      </p-card>
    </p-tabPanel>

    <p-tabPanel header="Send Message">
      <app-message-form></app-message-form>
    </p-tabPanel>
  </p-tabView>
</div>
